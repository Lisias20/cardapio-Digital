<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Checkout | Card√°pio Digital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#d32f2f" />
    <!-- Mercado Pago SDK (necess√°rio para o Brick de Cart√£o) -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
      :root {
        --primary: #d32f2f;
        --bg: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --card: #ffffff;
        --border: #e5e7eb;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
        color: var(--text);
        background: var(--bg);
      }
      a { color: var(--primary); text-decoration: none; }
      img { max-width: 100%; display: block; }
      .container { max-width: 960px; margin: 0 auto; padding: 16px; }
      header {
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, color-mix(in oklab, var(--primary), #fff 85%), #fff 90%);
      }
      .brand {
        display: flex; align-items: center; gap: 12px; padding: 12px 0;
      }
      .brand img { width: 40px; height: 40px; object-fit: cover; border-radius: 8px; }
      .brand h1 { font-size: 18px; margin: 0; }
      .tag {
        display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #f3f4f6; color: #374151;
      }
      main { padding: 12px 0 64px; }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 920px) {
        .grid {
          grid-template-columns: 1.2fr 0.8fr;
          align-items: start;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 0 rgba(0,0,0,0.02);
      }
      .card h2 { margin: 0 0 12px; font-size: 18px; }
      .row { display: flex; gap: 12px; align-items: center; }
      .row.wrap { flex-wrap: wrap; }
      .row.between { justify-content: space-between; }
      .muted { color: var(--muted); font-size: 14px; }
      .divider { height: 1px; background: var(--border); margin: 12px 0; }
      .input {
        width: 100%; padding: 10px 12px; border-radius: 8px;
        border: 1px solid var(--border); outline: none; background: #fff;
        font-size: 14px;
      }
      .input:focus { border-color: color-mix(in oklab, var(--primary), #000 30%); box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary), #fff 85%); }
      .label { display: block; font-size: 13px; margin: 8px 0 4px; }
      .radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
      .radio-pill {
        display: inline-flex; align-items: center; gap: 8px;
        border: 1px solid var(--border); border-radius: 999px; padding: 8px 12px;
        cursor: pointer; user-select: none; background: #fff;
      }
      .radio-pill input { accent-color: var(--primary); }
      .btn {
        appearance: none; border: none; border-radius: 10px;
        padding: 12px 16px; font-size: 15px; font-weight: 600; cursor: pointer;
      }
      .btn.primary { background: var(--primary); color: #fff; }
      .btn.secondary { background: #111827; color: #fff; }
      .btn.ghost { background: #fff; border: 1px solid var(--border); color: #111827; }
      .btn.block { width: 100%; }
      .btn[disabled] { opacity: .6; cursor: not-allowed; }
      .cart-item { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 8px 0; border-bottom: 1px dashed var(--border); }
      .qty { display: inline-flex; align-items: center; gap: 8px; }
      .qty button { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; }
      .summary { display: grid; gap: 6px; font-size: 14px; }
      .summary .line { display: flex; justify-content: space-between; }
      .summary .total { font-weight: 700; font-size: 16px; }
      .status {
        padding: 8px 12px; border-radius: 8px; background: #f9fafb; font-size: 14px;
      }
      .status.paid { background: #ecfdf5; color: #065f46; }
      .status.pending { background: #fffbeb; color: #92400e; }
      .status.failed { background: #fef2f2; color: #991b1b; }
      .pix-box {
        display: grid; gap: 8px; justify-items: center; text-align: center;
        border: 1px dashed var(--border); border-radius: 12px; padding: 12px;
        background: #fafafa;
      }
      .codebox {
        width: 100%; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 12px; background: #111827; color: #e5e7eb; border-radius: 8px; padding: 8px; overflow: auto;
      }
      .footer-note { font-size: 12px; color: var(--muted); margin-top: 12px; }
      .hidden { display: none !important; }
      .alert { padding: 10px 12px; border-radius: 8px; font-size: 14px; }
      .alert.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
      .alert.info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
      .skeleton {
        background: linear-gradient(90deg, #f3f4f6 25%, #f9fafb 37%, #f3f4f6 63%);
        background-size: 400% 100%;
        animation: shimmer 1.4s ease infinite;
        border-radius: 8px; height: 16px;
      }
      @keyframes shimmer { 0% {background-position: 100% 0;} 100%{background-position: 0 0;} }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="brand">
          <img id="storeLogo" alt="Logo da loja" src="" />
          <div>
            <h1 id="storeName">Carregando loja‚Ä¶</h1>
            <span id="storeMeta" class="tag">BRL ‚Ä¢ Hor√°rio local</span>
          </div>
          <span id="openTag" class="tag" style="margin-left:auto">Verificando hor√°rio‚Ä¶</span>
        </div>
      </div>
    </header>

    <main class="container">
      <div id="globalMessage" class="alert error hidden" role="alert" aria-live="polite"></div>

      <div class="grid">
        <!-- Coluna esquerda: Dados e Pagamento -->
        <section class="card" aria-labelledby="dadosTitulo">
          <h2 id="dadosTitulo">Dados do pedido</h2>

          <div class="label">Tipo de pedido</div>
          <div class="radio-group" role="radiogroup" aria-label="Tipo de pedido">
            <label class="radio-pill"><input type="radio" name="orderType" value="dine_in" /> Mesa</label>
            <label class="radio-pill"><input type="radio" name="orderType" value="pickup" /> Retirada</label>
            <label class="radio-pill"><input type="radio" name="orderType" value="delivery" /> Delivery</label>
          </div>
          <div id="tableContext" class="muted" style="margin-top:8px;"></div>

          <div id="deliveryFields" class="hidden" style="margin-top:12px;">
            <div class="row wrap">
              <div style="flex:1 1 240px;">
                <label class="label" for="customerName">Nome</label>
                <input class="input" id="customerName" autocomplete="name" placeholder="Seu nome" />
              </div>
              <div style="flex:1 1 200px;">
                <label class="label" for="customerPhone">Telefone (WhatsApp)</label>
                <input class="input" id="customerPhone" autocomplete="tel" placeholder="(11) 99999-9999" />
              </div>
            </div>
            <div class="row wrap">
              <div style="flex:1 1 140px;">
                <label class="label" for="cep">CEP</label>
                <input class="input" id="cep" inputmode="numeric" placeholder="00000-000" />
              </div>
              <div style="flex:2 1 260px;">
                <label class="label" for="address">Endere√ßo</label>
                <input class="input" id="address" placeholder="Rua, bairro, cidade" />
              </div>
            </div>
            <div class="row wrap">
              <div style="flex:1 1 120px;">
                <label class="label" for="number">N√∫mero</label>
                <input class="input" id="number" inputmode="numeric" placeholder="123" />
              </div>
              <div style="flex:2 1 260px;">
                <label class="label" for="complement">Complemento</label>
                <input class="input" id="complement" placeholder="Apto, bloco, ref." />
              </div>
            </div>
            <div style="margin-top:8px;">
              <label class="label" for="notes">Observa√ß√µes</label>
              <textarea class="input" id="notes" rows="2" placeholder="Ex.: sem cebola, tocar interfone..."></textarea>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label class="label" for="coupon">Cupom (opcional)</label>
            <div class="row">
              <input class="input" id="coupon" placeholder="Digite seu cupom" style="flex:1" />
              <button id="applyCouponBtn" class="btn ghost" type="button">Aplicar</button>
            </div>
            <div id="couponMsg" class="muted"></div>
          </div>

          <div class="divider"></div>

          <div class="row between">
            <button id="backToMenu" class="btn ghost" type="button">‚Üê Voltar ao card√°pio</button>
            <button id="continueBtn" class="btn primary" type="button">Continuar para pagamento</button>
          </div>

          <div id="paymentSection" class="hidden" style="margin-top:18px;">
            <h2>Pagamento</h2>
            <div class="radio-group" role="radiogroup" aria-label="M√©todo de pagamento" style="margin-bottom:8px;">
              <label class="radio-pill"><input type="radio" name="payMethod" value="pix" checked /> PIX</label>
              <label class="radio-pill"><input type="radio" name="payMethod" value="card" /> Cart√£o</label>
            </div>

            <!-- PIX -->
            <div id="pixContainer" class="pix-box hidden" aria-live="polite">
              <div id="pixBefore">
                <p>Geraremos um QR Code PIX din√¢mico. Validade ~15 min.</p>
                <button id="genPixBtn" class="btn secondary" type="button">Gerar QR Code PIX</button>
              </div>
              <div id="pixAfter" class="hidden">
                <img id="pixImage" alt="QR Code PIX" width="220" height="220" />
                <div class="row wrap" style="gap:8px;">
                  <button id="copyPixBtn" class="btn ghost" type="button">Copiar c√≥digo PIX</button>
                  <span id="pixExpires" class="muted"></span>
                </div>
                <div class="codebox" id="pixCodeBox" tabindex="0" aria-label="C√≥digo copia e cola PIX"></div>
                <div id="pixStatus" class="status pending">Aguardando pagamento PIX‚Ä¶</div>
                <a id="trackLinkPix" class="btn primary hidden" href="#">Acompanhar pedido</a>
              </div>
            </div>

            <!-- Cart√£o (Mercado Pago Bricks) -->
            <div id="cardContainer" class="hidden">
              <div id="cardBrick" class="card" style="padding:0; border:none; box-shadow:none;"></div>
              <div id="cardStatus" class="status pending hidden" aria-live="polite"></div>
              <a id="trackLinkCard" class="btn primary hidden" href="#">Acompanhar pedido</a>
            </div>

            <div class="footer-note">
              Pagamentos processados por Mercado Pago. N√£o armazenamos dados sens√≠veis do cart√£o.
            </div>
          </div>
        </section>

        <!-- Coluna direita: Carrinho e Totais -->
        <aside class="card" aria-labelledby="resumoTitulo">
          <h2 id="resumoTitulo">Resumo do pedido</h2>
          <div id="cartList"></div>
          <div class="divider"></div>
          <div class="summary" aria-live="polite">
            <div class="line"><span>Subtotal</span><strong id="subtotalVal">‚Äî</strong></div>
            <div class="line"><span>Embalagem</span><span id="packagingVal">‚Äî</span></div>
            <div class="line"><span>Entrega</span><span id="deliveryVal">‚Äî</span></div>
            <div class="line"><span>Desconto</span><span id="discountVal">‚Äî</span></div>
            <div class="line total"><span>Total</span><span id="totalVal">‚Äî</span></div>
          </div>
          <div class="footer-note" id="storeFeesNote"></div>
        </aside>
      </div>
    </main>

    <script>
      // Util: formata√ß√£o BRL
      const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
      const tz = 'America/Sao_Paulo';

      // Estado local
      const state = {
        storeSlug: null,
        store: null,
        tableId: null,
        orderType: 'pickup', // default
        coupon: null,
        quote: null,
        cart: null,
        orderId: null,
        payMethod: 'pix',
        sse: null,
        mp: null,
        cardBrick: null,
        cardBrickMounted: false,
        pixData: null
      };

      // Elementos
      const el = {
        storeLogo: document.getElementById('storeLogo'),
        storeName: document.getElementById('storeName'),
        storeMeta: document.getElementById('storeMeta'),
        openTag: document.getElementById('openTag'),
        tableContext: document.getElementById('tableContext'),
        deliveryFields: document.getElementById('deliveryFields'),
        backToMenu: document.getElementById('backToMenu'),
        continueBtn: document.getElementById('continueBtn'),
        paymentSection: document.getElementById('paymentSection'),
        cartList: document.getElementById('cartList'),
        subtotalVal: document.getElementById('subtotalVal'),
        packagingVal: document.getElementById('packagingVal'),
        deliveryVal: document.getElementById('deliveryVal'),
        discountVal: document.getElementById('discountVal'),
        totalVal: document.getElementById('totalVal'),
        storeFeesNote: document.getElementById('storeFeesNote'),
        globalMessage: document.getElementById('globalMessage'),

        // Fields
        customerName: document.getElementById('customerName'),
        customerPhone: document.getElementById('customerPhone'),
        cep: document.getElementById('cep'),
        address: document.getElementById('address'),
        number: document.getElementById('number'),
        complement: document.getElementById('complement'),
        notes: document.getElementById('notes'),
        coupon: document.getElementById('coupon'),
        applyCouponBtn: document.getElementById('applyCouponBtn'),
        couponMsg: document.getElementById('couponMsg'),

        // Payment
        pixContainer: document.getElementById('pixContainer'),
        genPixBtn: document.getElementById('genPixBtn'),
        pixBefore: document.getElementById('pixBefore'),
        pixAfter: document.getElementById('pixAfter'),
        pixImage: document.getElementById('pixImage'),
        pixCodeBox: document.getElementById('pixCodeBox'),
        copyPixBtn: document.getElementById('copyPixBtn'),
        pixExpires: document.getElementById('pixExpires'),
        pixStatus: document.getElementById('pixStatus'),
        trackLinkPix: document.getElementById('trackLinkPix'),

        cardContainer: document.getElementById('cardContainer'),
        cardBrick: document.getElementById('cardBrick'),
        cardStatus: document.getElementById('cardStatus'),
        trackLinkCard: document.getElementById('trackLinkCard')
      };

      // Helpers
      function showError(msg) {
        el.globalMessage.textContent = msg;
        el.globalMessage.classList.remove('hidden');
        setTimeout(() => el.globalMessage.classList.add('hidden'), 7000);
      }
      function setCSSTheme(primary) {
        if (primary) {
          document.documentElement.style.setProperty('--primary', primary);
          document.querySelector('meta[name="theme-color"]').setAttribute('content', primary);
        }
      }
      function parseStoreSlug() {
        const parts = location.pathname.split('/').filter(Boolean); // e.g. ["cantina","checkout"]
        return parts[0] || null;
      }
      function getCartKey() {
        return `cart_${state.storeSlug}`;
      }
      function getTableKey() {
        return `table_${state.storeSlug}`;
      }
      function loadCart() {
        try {
          const raw = localStorage.getItem(getCartKey());
          if (!raw) return null;
          const cart = JSON.parse(raw);
          if (!cart || !Array.isArray(cart.items) || cart.items.length === 0) return null;
          return cart;
        } catch { return null; }
      }
      function saveCart(cart) {
        localStorage.setItem(getCartKey(), JSON.stringify(cart));
      }
      function formatCents(cents) {
        if (typeof cents !== 'number') return '‚Äî';
        return BRL.format(cents / 100);
      }
      function isOpenNow(openHoursJson) {
        // MVP: assume backend bloqueia; aqui apenas exibe "Aberto/Fechado" superficialmente
        return true;
      }
      function getOrderTypeFromRadios() {
        const r = document.querySelector('input[name="orderType"]:checked');
        return r ? r.value : 'pickup';
      }
      function getPayMethod() {
        const r = document.querySelector('input[name="payMethod"]:checked');
        return r ? r.value : 'pix';
      }

      // Render carrinho
      function renderCart() {
        const c = state.cart;
        if (!c || !c.items || c.items.length === 0) {
          el.cartList.innerHTML = `
            <div class="alert info">Seu carrinho est√° vazio. Volte ao card√°pio para adicionar itens.</div>
          `;
          el.continueBtn.disabled = true;
          return;
        }
        el.continueBtn.disabled = false;
        el.cartList.innerHTML = c.items.map((item, idx) => {
          const opts = item.options && item.options.length
            ? `<div class="muted" style="margin-top:2px;">${item.options.map(o => `${o.name} (+${formatCents(o.price || 0)})`).join(', ')}</div>`
            : '';
          return `
            <div class="cart-item" data-idx="${idx}">
              <div>
                <div><strong>${item.name}</strong></div>
                ${opts}
                ${item.note ? `<div class="muted">Obs.: ${item.note}</div>` : ''}
                <div class="muted">${formatCents(item.unitPrice || item.price || 0)} un.</div>
              </div>
              <div class="qty">
                <button type="button" data-act="dec" aria-label="Diminuir">‚àí</button>
                <span aria-live="polite">${item.qty}</span>
                <button type="button" data-act="inc" aria-label="Aumentar">+</button>
              </div>
            </div>
          `;
        }).join('');

        // Eventos +/-
        el.cartList.querySelectorAll('.cart-item .qty button').forEach(btn => {
          btn.addEventListener('click', () => {
            const parent = btn.closest('.cart-item');
            const idx = Number(parent.dataset.idx);
            const act = btn.dataset.act;
            const it = state.cart.items[idx];
            if (act === 'inc') it.qty += 1;
            if (act === 'dec') it.qty = Math.max(0, it.qty - 1);
            state.cart.items = state.cart.items.filter(x => x.qty > 0);
            saveCart(state.cart);
            renderCart();
            // Recalcular resumo no backend ao continuar; aqui apenas limpa valores
            el.subtotalVal.textContent = '‚Äî';
            el.totalVal.textContent = '‚Äî';
          });
        });
      }

      // Atualiza radios/visibilidade dos campos de delivery
      function updateOrderTypeUI() {
        state.orderType = getOrderTypeFromRadios();
        if (state.orderType === 'delivery') {
          el.deliveryFields.classList.remove('hidden');
        } else {
          el.deliveryFields.classList.add('hidden');
        }
      }

      // Monta payload simples de itens para backend
      function buildItemsPayload() {
        return state.cart.items.map(it => ({
          productId: it.productId,
          qty: it.qty,
          note: it.note || '',
          options: (it.options || []).map(o => o.optionId || o.id) // enviar apenas IDs
        }));
      }

      // Quote de totais
      async function quoteTotals() {
        const payload = {
          type: state.orderType,
          items: buildItemsPayload(),
          coupon: state.coupon || undefined
        };
        if (state.orderType === 'dine_in' && state.tableId) {
          payload.tableId = state.tableId;
        }
        if (state.orderType === 'delivery') {
          payload.delivery = {
            cep: el.cep.value || '',
            address: el.address.value || '',
            number: el.number.value || '',
            complement: el.complement.value || ''
          };
        }
        const res = await fetch(`/${state.storeSlug}/checkout/quote`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Falha ao calcular totais');
        state.quote = data;
        // Atualiza UI
        el.subtotalVal.textContent = formatCents(data.subtotal);
        el.packagingVal.textContent = formatCents(data.packagingFee || 0);
        el.deliveryVal.textContent = formatCents(data.deliveryFee || 0);
        el.discountVal.textContent = data.discount ? `‚àí ${formatCents(Math.abs(data.discount))}` : formatCents(0);
        el.totalVal.textContent = formatCents(data.total);
        return data;
      }

      // Valida√ß√£o b√°sica de campos
      function validateBeforeOrder() {
        if (!state.cart || !state.cart.items || state.cart.items.length === 0) {
          throw new Error('Carrinho vazio.');
        }
        if (state.orderType === 'dine_in' && !state.tableId) {
          throw new Error('Mesa n√£o identificada. Leia o QR da mesa novamente.');
        }
        if (state.orderType === 'delivery') {
          if (!el.customerName.value.trim()) throw new Error('Informe seu nome.');
          if (!el.customerPhone.value.trim()) throw new Error('Informe seu telefone.');
          if (!el.cep.value.trim()) throw new Error('Informe seu CEP.');
          if (!el.address.value.trim()) throw new Error('Informe seu endere√ßo.');
          if (!el.number.value.trim()) throw new Error('Informe o n√∫mero.');
        }
      }

      // Cria√ß√£o do pedido no backend
      async function createOrder() {
        const payload = {
          storeSlug: state.storeSlug,
          type: state.orderType,
          tableId: state.orderType === 'dine_in' ? state.tableId : null,
          items: buildItemsPayload(),
          customerName: state.orderType === 'delivery' ? el.customerName.value.trim() : '',
          customerPhone: state.orderType === 'delivery' ? el.customerPhone.value.trim() : '',
          addressJson: state.orderType === 'delivery' ? {
            cep: el.cep.value.trim(),
            address: el.address.value.trim(),
            number: el.number.value.trim(),
            complement: el.complement.value.trim(),
            notes: el.notes.value.trim()
          } : null,
          coupon: state.coupon || null,
          // O backend recalcula os totais; aqui apenas passamos indicativo
          totalsHint: state.quote ? {
            subtotal: state.quote.subtotal,
            deliveryFee: state.quote.deliveryFee,
            packagingFee: state.quote.packagingFee,
            discount: state.quote.discount,
            total: state.quote.total
          } : undefined
        };
        const res = await fetch(`/${state.storeSlug}/orders`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Falha ao criar pedido');
        state.orderId = data.orderId || data.id;
        // Conecta SSE para acompanhar status/pagamento
        connectOrderSSE();
        return state.orderId;
      }

      function connectOrderSSE() {
        // encerra anterior
        if (state.sse) { state.sse.close(); state.sse = null; }
        if (!state.orderId) return;
        const url = `/orders/${state.orderId}/stream`;
        const es = new EventSource(url);
        state.sse = es;
        es.addEventListener('message', (ev) => {
          try {
            const data = JSON.parse(ev.data);
            handleOrderUpdate(data);
          } catch {}
        });
        es.addEventListener('error', (err) => {
          console.warn('SSE erro', err);
        });
      }

      function handleOrderUpdate(order) {
        if (!order) return;
        const paid = order.paymentStatus === 'paid';
        if (state.payMethod === 'pix') {
          el.pixStatus.textContent =
            order.paymentStatus === 'pending' ? 'Aguardando pagamento PIX‚Ä¶' :
            order.paymentStatus === 'paid' ? 'Pagamento confirmado! üéâ' :
            order.paymentStatus === 'failed' ? 'Pagamento falhou.' :
            `Pagamento: ${order.paymentStatus}`;
          el.pixStatus.className = `status ${order.paymentStatus}`;
          if (paid) {
            el.trackLinkPix.classList.remove('hidden');
            el.trackLinkPix.href = `/order/${state.orderId}`;
          }
        } else if (state.payMethod === 'card') {
          el.cardStatus.textContent =
            order.paymentStatus === 'paid' ? 'Pagamento aprovado! üéâ' :
            order.paymentStatus === 'pending' ? 'Processando pagamento‚Ä¶' :
            order.paymentStatus === 'failed' ? 'Pagamento recusado.' :
            `Pagamento: ${order.paymentStatus}`;
          el.cardStatus.className = `status ${order.paymentStatus}`;
          if (paid) {
            el.trackLinkCard.classList.remove('hidden');
            el.trackLinkCard.href = `/order/${state.orderId}`;
          }
        }
      }

      // PIX flow
      async function generatePix() {
        if (!state.orderId) throw new Error('Pedido inexistente');
        const res = await fetch(`/payments/mercadopago/intent`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ op: 'pix', orderId: state.orderId, storeSlug: state.storeSlug })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Falha ao gerar PIX');
        state.pixData = data;
        // Render
        if (data.qr_code_base64) {
          el.pixImage.src = `data:image/png;base64,${data.qr_code_base64}`;
          el.pixImage.alt = 'QR Code PIX';
        }
        el.pixCodeBox.textContent = data.copyPaste || data.qr_code || '‚Äî';
        if (data.expiresAt) {
          const dt = new Date(data.expiresAt);
          el.pixExpires.textContent = `Expira √†s ${dt.toLocaleTimeString('pt-BR', { timeZone: tz, hour: '2-digit', minute: '2-digit' })}`;
        } else {
          el.pixExpires.textContent = '';
        }
        // Mostra container do PIX gerado
        el.pixBefore.classList.add('hidden');
        el.pixAfter.classList.remove('hidden');
        el.pixStatus.textContent = 'Aguardando pagamento PIX‚Ä¶';
        el.pixStatus.className = 'status pending';
      }

      // Cart√£o flow (Mercado Pago Bricks)
      async function initCardBrick() {
        if (state.cardBrickMounted) return;
        // Solicita chave p√∫blica e valor ao backend
        const res = await fetch(`/payments/mercadopago/intent`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ op: 'card_init', orderId: state.orderId, storeSlug: state.storeSlug })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Falha ao inicializar pagamento com cart√£o');

        // Instancia MP
        if (!state.mp) {
          state.mp = new MercadoPago(data.publicKey, { locale: 'pt-BR' });
        }
        const bricksBuilder = state.mp.bricks();

        const amount = (state.quote && state.quote.total ? state.quote.total : data.amount) / 100;

        const settings = {
          initialization: {
            amount: Number(amount.toFixed(2))
          },
          customization: {
            paymentMethods: {
              creditCard: 'all',
              debitCard: 'all',
              mercadoPago: 'all'
            },
            visual: {
              style: { theme: 'default' }
            }
          },
          callbacks: {
            onReady: () => {},
            onSubmit: async (cardFormData) => {
              // Envia token e dados para o backend processar o pagamento
              try {
                el.cardStatus.classList.remove('hidden');
                el.cardStatus.textContent = 'Processando‚Ä¶';
                el.cardStatus.className = 'status pending';
                const resp = await fetch('/payments/mercadopago/intent', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    op: 'card_pay',
                    orderId: state.orderId,
                    storeSlug: state.storeSlug,
                    cardFormData
                  })
                });
                const out = await resp.json();
                if (!resp.ok) {
                  throw new Error(out.message || 'Pagamento recusado');
                }
                // Atualiza status local; webhook ajustar√° oficialmente
                if (out.status === 'approved') {
                  el.cardStatus.textContent = 'Pagamento aprovado! üéâ';
                  el.cardStatus.className = 'status paid';
                  el.trackLinkCard.classList.remove('hidden');
                  el.trackLinkCard.href = `/order/${state.orderId}`;
                } else if (out.status === 'in_process') {
                  el.cardStatus.textContent = 'Pagamento em an√°lise‚Ä¶';
                  el.cardStatus.className = 'status pending';
                } else {
                  el.cardStatus.textContent = 'Pagamento recusado.';
                  el.cardStatus.className = 'status failed';
                }
              } catch (err) {
                showError(err.message || 'Erro no pagamento');
                el.cardStatus.textContent = 'Pagamento recusado.';
                el.cardStatus.className = 'status failed';
              }
            },
            onError: (err) => {
              console.error('Card Brick error', err);
              showError('Erro no componente de cart√£o.');
            }
          }
        };

        state.cardBrick = await bricksBuilder.create('cardPayment', 'cardBrick', settings);
        state.cardBrickMounted = true;
      }

      // Alterna UI por m√©todo de pagamento
      function updatePaymentUI() {
        state.payMethod = getPayMethod();
        if (state.payMethod === 'pix') {
          el.pixContainer.classList.remove('hidden');
          el.cardContainer.classList.add('hidden');
        } else {
          el.pixContainer.classList.add('hidden');
          el.cardContainer.classList.remove('hidden');
          // Inicializa brick sob demanda
          initCardBrick().catch(err => showError(err.message || 'Falha ao inicializar cart√£o'));
        }
      }

      // Eventos
      document.addEventListener('change', (ev) => {
        if (ev.target.name === 'orderType') {
          updateOrderTypeUI();
        }
        if (ev.target.name === 'payMethod') {
          updatePaymentUI();
        }
      });

      el.backToMenu.addEventListener('click', () => {
        if (!state.storeSlug) return;
        location.href = `/${state.storeSlug}`;
      });

      el.applyCouponBtn.addEventListener('click', async () => {
        const code = el.coupon.value.trim();
        if (!code) return;
        state.coupon = code;
        try {
          await quoteTotals();
          el.couponMsg.textContent = 'Cupom aplicado.';
          el.couponMsg.classList.remove('muted');
        } catch (err) {
          state.coupon = null;
          el.couponMsg.textContent = 'Cupom inv√°lido.';
        }
      });

      el.continueBtn.addEventListener('click', async () => {
        try {
          validateBeforeOrder();
          el.continueBtn.disabled = true;
          // Calcula totais
          await quoteTotals();
          // Cria pedido
          await createOrder();
          // Abre se√ß√£o de pagamento
          el.paymentSection.classList.remove('hidden');
          // Define m√©todo atual
          updatePaymentUI();
          // Configura link de tracking padr√£o
          el.trackLinkPix.href = `/order/${state.orderId}`;
          el.trackLinkCard.href = `/order/${state.orderId}`;
          // Se for mesa, esconde sele√ß√£o de tipo
          // (opcional: manter bloqueado desde o in√≠cio)
        } catch (err) {
          showError(err.message || 'Falha ao continuar');
        } finally {
          el.continueBtn.disabled = false;
        }
      });

      el.genPixBtn.addEventListener('click', async () => {
        el.genPixBtn.disabled = true;
        try {
          await generatePix();
        } catch (err) {
          showError(err.message || 'Falha ao gerar PIX');
        } finally {
          el.genPixBtn.disabled = false;
        }
      });

      el.copyPixBtn.addEventListener('click', async () => {
        if (!state.pixData) return;
        try {
          await navigator.clipboard.writeText(state.pixData.copyPaste || state.pixData.qr_code || '');
          el.copyPixBtn.textContent = 'Copiado!';
          setTimeout(() => el.copyPixBtn.textContent = 'Copiar c√≥digo PIX', 2000);
        } catch {
          showError('N√£o foi poss√≠vel copiar. Selecione o texto manualmente.');
        }
      });

      // Boot
      (async function init() {
        state.storeSlug = parseStoreSlug();
        if (!state.storeSlug) {
          showError('Loja n√£o encontrada na URL.');
          return;
        }

        // Carrega dados da loja pelo menu
        try {
          const res = await fetch(`/${state.storeSlug}/menu`);
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'Falha ao carregar loja');
          state.store = data.store || data;
          // Tema e header
          setCSSTheme(state.store.themePrimary);
          el.storeName.textContent = state.store.name || 'Minha Loja';
          el.storeLogo.src = state.store.logoUrl || 'https://via.placeholder.com/80?text=Logo';
          el.storeLogo.alt = `Logo da ${state.store.name || 'loja'}`;
          el.storeMeta.textContent = 'R$ ‚Ä¢ Hor√°rio local';
          el.openTag.textContent = isOpenNow(state.store.openHours) ? 'Aberto' : 'Fechado';
          if (!isOpenNow(state.store.openHours)) {
            el.openTag.style.background = '#fef3c7';
            el.openTag.style.color = '#92400e';
            showError('Loja fechada no momento. Voc√™ pode montar o pedido, mas o pagamento pode ser bloqueado.');
          }
          el.storeFeesNote.textContent = `Taxa de entrega: ${formatCents(state.store.deliveryFee || 0)} ‚Ä¢ Embalagem: ${formatCents(state.store.packagingFee || 0)}`;
        } catch (err) {
          showError(err.message || 'Erro ao carregar loja');
        }

        // Carrega carrinho
        state.cart = loadCart();
        if (!state.cart) {
          el.cartList.innerHTML = `<div class="alert info">Seu carrinho est√° vazio. <a href="/${state.storeSlug}">Voltar ao card√°pio</a>.</div>`;
          el.continueBtn.disabled = true;
        } else {
          renderCart();
        }

        // Contexto de mesa via localStorage (definido ao escanear QR)
        const tableId = localStorage.getItem(getTableKey());
        if (tableId) {
          state.tableId = tableId;
          state.orderType = 'dine_in';
          // Marca radio e bloqueia altera√ß√£o (MVP)
          document.querySelectorAll('input[name="orderType"]').forEach(r => {
            r.checked = r.value === 'dine_in';
            r.disabled = r.value !== 'dine_in';
          });
          el.tableContext.textContent = `Mesa: ${tableId}`;
        } else {
          // Sele√ß√£o default: retirada
          document.querySelector(`input[name="orderType"][value="pickup"]`).checked = true;
          el.tableContext.textContent = '';
        }

        updateOrderTypeUI();

        // M√©todo pagamento default: PIX
        document.querySelector(`input[name="payMethod"][value="pix"]`).checked = true;
        updatePaymentUI();
      })();
    </script>
  </body>
</html>